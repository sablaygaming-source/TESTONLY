import json
import os
import uuid
import requests
from datetime import datetime, timezone, timedelta

from flask import Flask, request, jsonify, send_from_directory
from flask_cors import CORS

app = Flask(__name__)
CORS(app) # This handles the "Locked Door" (CORS) issue

#old URL
#MAKE_WEBHOOK_URL = 'https://hook.eu1.make.com/1s442riabjmpt3dubtwyv9hadn815ek1'

MAKE_WEBHOOK_URL = 'https://hook.eu1.make.com/1s442riabjmpt3dubtwyv9hadn815ek1'


FILE_NAME = "users.json"

# The data you want to send
mainData = {
    "sender_name": "RSM2026",
    "recipient": "migelbonie@gmail.com",
    "subject": "None",
    "message": "None",
    "data": {},
    "remark": "None", 
    "status": "Success"
}

headers = {
    "Content-Type": "application/json"
}

def save_to_json(new_user_data): #2
    global mainData

    # 1. Load existing data or start fresh
    if os.path.exists(FILE_NAME): #3
        with open(FILE_NAME, "r") as file:  #4        
            try: #5
                data = json.load(file)
            except json.JSONDecodeError: #5
                data = []
            #5
        #4
    else: #3
        data = []
    #3
    
    # 2. Add automatic fields
    new_user_data["id"] = str(uuid.uuid4())[:8]
    ph_time = datetime.now(timezone.utc) + timedelta(hours=8)
    new_user_data["date"] = ph_time.strftime("%Y-%m-%d %H:%M:%S")
    mainData["data"] = new_user_data.copy()
    mainData["subject"] = f"Date: {new_user_data['date']} DO NOT REPLY MACHINE RSM SENDED"
    mainData["message"] = f"This date {new_user_data['date']}<BR>new id: {new_user_data['id'] }<BR>new user: {new_user_data['username']}<BR>Is been recorded successfully"

    data.append(mainData)

    with open(FILE_NAME, "w") as file: #7
        json.dump(data, file, indent=4)
    #7
    return new_user_data

#2

# ROUTE 1: Serves your Frontend
@app.route("/")
def index():#2
    
    return send_from_directory('.', 'index.html')
#2

# ROUTE 2: Handles the Sign Up
@app.route("/signup", methods=["POST"])
def signup(): #2
    global mainData
    user_data = request.json
    # Simple check for required fields
    if not user_data.get("username") or not user_data.get("email"):#3
        return jsonify({"status": "error", "message": "Missing fields"}), 400
        
    save_to_json(user_data)
    
    #send data to make.com
    fSendData()
    
    return jsonify({"status": "success", "user": mainData}), 201
    #3
#2

def fSendData():#2
    print("\n\ndebug 1 now sending...")
    global mainData
    try: #3
        response = requests.post(
            MAKE_WEBHOOK_URL, 
            json= mainData, 
            headers=headers
        )

        if response.status_code == 200: #4
            print(f"✅ Success! Make.com is now sending the email to {mainData['recipient']}")
        else:
            print(f"❌ Failed. Error code: {response.status_code}")
            # If you see 410, remember to click 'Re-determine data structure' in Make
            print("Response Text:", response.text)
        #4
    except Exception as e: #3
        print(f"Connection Error: {e}")
    
    #3
#2


if __name__ == "__main__":
    print(f"\n\n##################\ndebug RSM program is starting")
    app.run(debug=True)
    print(f"\n\n##################\ndebug RSM EXITING PROGRAM....")
